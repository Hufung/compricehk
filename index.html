<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComPriceHK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #a8d8ff 0%, #bde0fe 50%, #e0f7fa 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        #app {
            background: rgba(255, 255, 255, 0.6);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 24px;
            border: 1px solid rgba(209, 213, 219, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        .glass-input, .glass-button {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.5);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            padding: 14px 16px;
            font-size: 16px;
            width: 100%;
            cursor: pointer;
            color: #1f2937;
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }

        .glass-input:hover, .glass-button:hover {
            background: rgba(255, 255, 255, 0.7);
        }
        
        .glass-input {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22m5%206%205%208%205-8%22%20stroke%3D%22%23374151%22%20stroke-width%3D%222%22%20fill%3D%22none%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
        .primary-button {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
            border: none;
        }
        .primary-button:hover {
            background-color: #2563eb;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .ios-label {
            color: #374151;
            font-weight: 500;
            margin-bottom: 6px;
            display: block;
            font-size: 14px;
            padding-left: 4px;
        }
        #results {
            background: rgba(59, 130, 246, 0.1);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 14px;
            min-height: 120px;
            color: #1e3a8a;
            font-weight: 500;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <main id="app" class="w-full max-w-md mx-auto p-6 md:p-8 space-y-6">
        <div id="loader" class="text-center py-8">
            <div class="spinner h-12 w-12 rounded-full border-4 border-t-blue-500 border-gray-200 mx-auto"></div>
            <p id="loader-text" class="mt-4 text-gray-600">正在載入數據...</br> It takes some time for first loading.</p>
        </div>
        <div id="main-content" class="hidden">
            <header class="text-center mb-6">
                <h1 id="app-title" class="text-3xl font-bold text-gray-800">香港超市價格比較</h1>
                <p id="app-subtitle" class="text-gray-500 mt-1">HK Supermarket Price Comparison</p>
            </header>
            <section class="flex gap-2 mb-4">
                <button id="lang-toggle-btn" class="glass-button text-sm">English</button>
                <button id="update-data-btn" class="glass-button text-sm">更新數據</button>
            </section>
            <section class="space-y-5">
                <div>
                    <label for="spinner1" id="label-cat1" class="ios-label">貨品分類 1</label>
                    <select id="spinner1" class="glass-input"></select>
                </div>
                <div>
                    <label for="spinner2" id="label-cat2" class="ios-label">貨品分類 2</label>
                    <select id="spinner2" class="glass-input"></select>
                </div>
                <div>
                    <label for="spinner3" id="label-cat3" class="ios-label">貨品分類 3</label>
                    <select id="spinner3" class="glass-input"></select>
                </div>
                <div>
                    <label for="spinner4" id="label-product" class="ios-label">貨品名稱</label>
                    <select id="spinner4" class="glass-input"></select>
                </div>
                <button id="show-price-btn" class="glass-button primary-button w-full !mt-6 py-3">顯示價格</button>
            </section>
            <section id="results-container" class="mt-6">
                 <h2 id="results-title" class="font-semibold text-lg text-gray-700 mb-2 px-1">價格詳情</h2>
                 <div id="results" class="p-4 whitespace-pre-wrap text-sm leading-relaxed">
                    請選擇商品以查看價格。
                 </div>
            </section>
        </div>
        <div id="error-message" class="hidden text-center text-red-600 bg-red-100 p-4 rounded-lg"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            const errorMessage = document.getElementById('error-message');
            const spinner1 = document.getElementById('spinner1');
            const spinner2 = document.getElementById('spinner2');
            const spinner3 = document.getElementById('spinner3');
            const spinner4 = document.getElementById('spinner4');
            const showPriceBtn = document.getElementById('show-price-btn');
            const resultsDiv = document.getElementById('results');
            const langToggleBtn = document.getElementById('lang-toggle-btn');
            const updateDataBtn = document.getElementById('update-data-btn');

            let dataStore = {};
            let currentLanguage = 'zh';

            const supermarketNames = {
                'AEON': { zh: '永旺', en: 'AEON' },
                'PARKNSHOP': { zh: '百佳', en: 'PARKNSHOP' },
                'WELLCOME': { zh: '惠康', en: 'Wellcome' },
                'JASONS': { zh: 'Market Place', en: 'Market Place' },
                'MANNINGS': { zh: '萬寧', en: 'MANNINGS' },
                'WATSONS': { zh: '屈臣氏', en: 'WATSONS' },
            };

            const translations = {
                zh: { title: '香港超市價格比較', subtitle: 'HK Supermarket Price Comparison', toggleLang: 'English', updateData: '更新數據', loading: '正在載入數據...(It may need more time for first loading)', updating: '正在更新數據...', cat1: '貨品分類 1', cat2: '貨品分類 2', cat3: '貨品分類 3', product: '貨品名稱', showPrice: '顯示價格', resultsTitle: '價格詳情', initialResult: '請選擇商品以查看價格。', selectCat1: '選擇分類 1', selectCat2: '選擇分類 2', selectCat3: '選擇分類 3', selectProduct: '選擇貨品', noPriceInfo: '暫無此商品的價格信息。', selectProductFirst: '請先從上方列表選擇一個完整的商品名稱。', dataError: '無法載入數據。請稍後再試。', productLabel: '商品', brandLabel: '品牌', priceLabel: '價格', offerLabel: '優惠', noOffer: '無', supermarketLabel: '超市' },
                en: { title: 'HK Supermarket Price Comparison', subtitle: '香港超市價格比較', toggleLang: '中文', updateData: 'Update Data', loading: 'Loading data...(It may need more time for first loading)', updating: 'Updating data...', cat1: 'Category 1', cat2: 'Category 2', cat3: 'Category 3', product: 'Product Name', showPrice: 'Show Price', resultsTitle: 'Price Details', initialResult: 'Please select a product to see prices.', selectCat1: 'Select Category 1', selectCat2: 'Select Category 2', selectCat3: 'Select Category 3', selectProduct: 'Select Product', noPriceInfo: 'No price information available for this product.', selectProductFirst: 'Please select a complete product name from the list above.', dataError: 'Could not load data. Please try again later.', productLabel: 'Product', brandLabel: 'Brand', priceLabel: 'Price', offerLabel: 'Offer', noOffer: 'None', supermarketLabel: 'Supermarket' }
            };
            
            function setLanguage(lang) {
                currentLanguage = lang;
                document.documentElement.lang = lang === 'zh' ? 'zh-Hant' : 'en';
                const t = translations[lang];

                document.title = t.title;
                
                document.getElementById('app-title').textContent = t.title;
                document.getElementById('app-subtitle').textContent = t.subtitle;
                document.getElementById('lang-toggle-btn').textContent = t.toggleLang;
                document.getElementById('update-data-btn').textContent = t.updateData;
                document.getElementById('label-cat1').textContent = t.cat1;
                document.getElementById('label-cat2').textContent = t.cat2;
                document.getElementById('label-cat3').textContent = t.cat3;
                document.getElementById('label-product').textContent = t.product;
                document.getElementById('show-price-btn').textContent = t.showPrice;
                document.getElementById('results-title').textContent = t.resultsTitle;

                populateSpinner(spinner1, Object.keys(dataStore.categories || {}).sort(), t.selectCat1);
                resetSpinner(spinner2, t.selectCat2);
                resetSpinner(spinner3, t.selectCat3);
                resetSpinner(spinner4, t.selectProduct);
                
                if(resultsDiv.textContent === translations.zh.initialResult || resultsDiv.textContent === translations.en.initialResult) {
                    resultsDiv.textContent = t.initialResult;
                } else {
                    showPrice();
                }
            }
            
            async function fetchWithRetry(url, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                        return response;
                    } catch (error) {
                        if (i === retries - 1) throw error;
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            }

            async function loadData(isUpdate = false) {
                const t = translations[currentLanguage];
                loader.classList.remove('hidden');
                mainContent.classList.add('hidden');
                document.getElementById('loader-text').textContent = isUpdate ? t.updating : t.loading;

                const dataUrl = "https://online-price-watch.consumer.org.hk/opw/opendata/pricewatch_zh-Hant.csv";
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(dataUrl)}`;

                try {
                    const response = await fetchWithRetry(proxyUrl);
                    const csvText = await response.text();
                    processData(parseCSV(csvText));
                    setLanguage(currentLanguage);

                    loader.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    errorMessage.classList.add('hidden');

                } catch (error) {
                    console.error("Failed to load or process data:", error);
                    loader.classList.add('hidden');
                    errorMessage.textContent = `${t.dataError}\nError: ${error.message}`;
                    errorMessage.classList.remove('hidden');
                }
            }

            function parseCSV(text) {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length !== headers.length) continue;
                    const entry = {};
                    headers.forEach((header, j) => entry[header] = values[j].trim());
                    data.push(entry);
                }
                return data;
            }
            
            function processData(data) {
                dataStore = { categories: {}, productDetails: {} };
                data.forEach(item => {
                    const c1 = item['貨品分類1'], c2 = item['貨品分類2'], c3 = item['貨品分類3'], name = item['貨品名稱'];
                    if (!c1 || !c2 || !c3 || !name) return;

                    if (!dataStore.categories[c1]) dataStore.categories[c1] = {};
                    if (!dataStore.categories[c1][c2]) dataStore.categories[c1][c2] = {};
                    if (!dataStore.categories[c1][c2][c3]) dataStore.categories[c1][c2][c3] = new Set();
                    dataStore.categories[c1][c2][c3].add(name);

                    if (!dataStore.productDetails[name]) {
                        dataStore.productDetails[name] = { brand: item['品牌'], prices: {} };
                    }
                    dataStore.productDetails[name].prices[item['超市代號']] = { price: item['價格'], offer: item['優惠'] };
                });
            }

            function populateSpinner(spinner, values, defaultText) {
                spinner.innerHTML = `<option value="">-- ${defaultText} --</option>`;
                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    spinner.appendChild(option);
                });
                spinner.disabled = values.length === 0;
            }

            function resetSpinner(spinner, defaultText) {
                spinner.innerHTML = `<option value="">-- ${defaultText} --</option>`;
                spinner.disabled = true;
            }
            
            function showPrice() {
                const selectedProduct = spinner4.value;
                const t = translations[currentLanguage];
                if (!selectedProduct) {
                    resultsDiv.textContent = t.selectProductFirst;
                    return;
                }

                const details = dataStore.productDetails[selectedProduct];
                if (!details) {
                    resultsDiv.textContent = t.noPriceInfo;
                    return;
                }

                let output = `${t.productLabel}: ${selectedProduct}\n`;
                output += `${t.brandLabel}: ${details.brand || 'N/A'}\n\n`;
                
                const supermarkets = Object.keys(details.prices);
                if (supermarkets.length > 0) {
                    supermarkets.forEach(code => {
                        const storeName = (supermarketNames[code] && supermarketNames[code][currentLanguage]) || code;
                        const priceInfo = details.prices[code];
                        output += `${t.supermarketLabel} ${storeName}: ${t.priceLabel} $${priceInfo.price}, ${t.offerLabel}: ${priceInfo.offer || t.noOffer}\n`;
                    });
                } else {
                    output += t.noPriceInfo;
                }
                resultsDiv.textContent = output;
            }

            spinner1.addEventListener('change', () => {
                const t = translations[currentLanguage];
                const c1 = spinner1.value;
                const values = c1 ? Object.keys(dataStore.categories[c1]).sort() : [];
                populateSpinner(spinner2, values, t.selectCat2);
                resetSpinner(spinner3, t.selectCat3);
                resetSpinner(spinner4, t.selectProduct);
                resultsDiv.textContent = t.initialResult;
            });

            spinner2.addEventListener('change', () => {
                const t = translations[currentLanguage];
                const c1 = spinner1.value;
                const c2 = spinner2.value;
                const values = c1 && c2 ? Object.keys(dataStore.categories[c1][c2]).sort() : [];
                populateSpinner(spinner3, values, t.selectCat3);
                resetSpinner(spinner4, t.selectProduct);
                resultsDiv.textContent = t.initialResult;
            });

            spinner3.addEventListener('change', () => {
                const t = translations[currentLanguage];
                const c1 = spinner1.value;
                const c2 = spinner2.value;
                const c3 = spinner3.value;
                const values = c1 && c2 && c3 ? Array.from(dataStore.categories[c1][c2][c3]).sort() : [];
                populateSpinner(spinner4, values, t.selectProduct);
                resultsDiv.textContent = t.initialResult;
            });
            
            showPriceBtn.addEventListener('click', showPrice);
            langToggleBtn.addEventListener('click', () => setLanguage(currentLanguage === 'en' ? 'zh' : 'en'));
            updateDataBtn.addEventListener('click', () => loadData(true));

            loadData();
        });
    </script>
</body>
</html>
